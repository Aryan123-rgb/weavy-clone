[{"filePath":"C:\\Users\\91895\\Desktop\\projects\\weavy-clone\\src\\components\\workflow\\nodes\\CropImageNode.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":9,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":36,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[142,153],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":55,"column":40,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":55,"endColumn":42,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1673,1675],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-type-assertion","severity":2,"message":"This assertion is unnecessary since it does not change the type of the expression.","line":63,"column":19,"nodeType":"TSAsExpression","messageId":"unnecessaryAssertion","endLine":63,"endColumn":74,"fix":{"range":[1895,1934],"text":""}},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":64,"column":35,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":64,"endColumn":37,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1971,1973],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":141,"column":25,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":141,"endColumn":27,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[4563,4565],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":236,"column":15,"nodeType":"JSXOpeningElement","endLine":240,"endColumn":17,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport {\r\n  Handle,\r\n  Position,\r\n  useReactFlow,\r\n  useHandleConnections,\r\n} from \"@xyflow/react\";\r\nimport React, { useState, useEffect } from \"react\";\r\nimport type { Node, NodeProps, Connection, Edge } from \"@xyflow/react\";\r\nimport { Crop as CropIcon } from \"lucide-react\";\r\nimport { cn } from \"~/lib/utils\";\r\nimport { useFlowStore } from \"~/store/flowStore\";\r\nimport { toast } from \"sonner\";\r\n\r\n// Define the data type for our node\r\ntype CropImageNodeData = {\r\n  label?: string;\r\n  imageUrl?: string; // The output url (Base64)\r\n};\r\n\r\ntype MyNode = Node<CropImageNodeData>;\r\n\r\nexport function CropImageNode({ data, selected, id }: NodeProps<MyNode>) {\r\n  const { updateNodeData, nodeData } = useFlowStore();\r\n  const { getEdges, getNodes } = useReactFlow();\r\n\r\n  // Inputs for crop percentages\r\n  const [cropParams, setCropParams] = useState({\r\n    x: 0,\r\n    y: 0,\r\n    width: 100,\r\n    height: 100,\r\n  });\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n\r\n  // Input connection tracking\r\n  const connections = useHandleConnections({ type: \"target\", id: \"image\" });\r\n\r\n  // Helper to get input image URL from connection\r\n  const getInputImage = () => {\r\n    const edges = getEdges();\r\n    const nodes = getNodes();\r\n\r\n    // Find edge connected to our 'image' handle\r\n    const edge = edges.find(\r\n      (e) => e.target === id && e.targetHandle === \"image\",\r\n    );\r\n    if (!edge) return null;\r\n\r\n    // Try store first (live data)\r\n    if (nodeData[edge.source]) {\r\n      const sourceData = nodeData[edge.source] as Record<string, unknown>;\r\n      // Support imageUrl (standard) or image (legacy)\r\n      const img = (sourceData.imageUrl || sourceData.image) as\r\n        | string\r\n        | undefined;\r\n      return img;\r\n    }\r\n\r\n    // Fallback to node data\r\n    const sourceNode = nodes.find((n) => n.id === edge.source);\r\n    const sData = sourceNode?.data as Record<string, unknown> | undefined;\r\n    const sImg = (sData?.imageUrl || sData?.image) as string | undefined;\r\n    return sImg;\r\n  };\r\n\r\n  const validateInput = (connection: Connection | Edge) => {\r\n    // connection.sourceHandle is the ID of the handle on the source node\r\n    const sourceHandleId = connection.sourceHandle;\r\n\r\n    // Only allow connection if the source handle is explicitly an image output\r\n    // We assume nodes outputting images use id=\"image\"\r\n    if (sourceHandleId === \"image\") return true;\r\n    return false;\r\n  };\r\n\r\n  const handleCrop = async () => {\r\n    const inputUrl = getInputImage();\r\n\r\n    if (!inputUrl || typeof inputUrl !== \"string\") {\r\n      toast.error(\"No input image detected\", {\r\n        description:\r\n          \"Please connect an image output (like Upload Image) to this node.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (!inputUrl.startsWith(\"data:image/\")) {\r\n      toast.error(\"Invalid Input Format\", {\r\n        description: \"The connected node must provide a Base64 Data URL.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    setIsProcessing(true);\r\n    try {\r\n      const { cropImage } = await import(\"~/app/actions\");\r\n\r\n      toast.promise(cropImage(inputUrl, cropParams), {\r\n        loading: \"Cropping image...\",\r\n        success: (result) => {\r\n          // Update local data and global store with result\r\n          updateNodeData(id, { imageUrl: result.url });\r\n          return \"Image Cropped Successfully\";\r\n        },\r\n        error: (err) => {\r\n          console.error(\"Crop error\", err);\r\n          return \"Crop Failed\";\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Action import failed\", error);\r\n      toast.error(\"Failed to start crop process\");\r\n    } finally {\r\n      setIsProcessing(false);\r\n    }\r\n  };\r\n\r\n  const handleParamChange = (field: keyof typeof cropParams, value: string) => {\r\n    const num = parseFloat(value);\r\n    if (!isNaN(num)) {\r\n      setCropParams((prev) => ({ ...prev, [field]: num }));\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"group relative flex w-80 flex-col rounded-xl border-2 bg-[#1A1A1A] text-white shadow-2xl transition-all\",\r\n        selected\r\n          ? \"border-[#E0FC00] shadow-[#E0FC00]/20\"\r\n          : \"border-white/10 hover:border-white/20\",\r\n      )}\r\n    >\r\n      {/* Header */}\r\n      <div className=\"flex h-10 items-center justify-between border-b border-white/5 bg-[#222] px-4 py-2\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <CropIcon className=\"h-4 w-4 text-[#E0FC00]\" />\r\n          <span className=\"text-xs font-semibold tracking-wider text-gray-400 uppercase\">\r\n            {data.label || \"Crop Image\"}\r\n          </span>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex flex-col gap-4 p-4\">\r\n        {/* Input Handle Visualization */}\r\n        <div className=\"relative\">\r\n          <div className=\"absolute top-1/2 -left-7 -translate-y-1/2\">\r\n            <Handle\r\n              type=\"target\"\r\n              position={Position.Left}\r\n              id=\"image\"\r\n              className={cn(\r\n                \"!relative !left-0 !h-3 !w-3 !border-2 !border-[#1A1A1A]\",\r\n                connections.length > 0 ? \"!bg-green-500\" : \"!bg-indigo-500\",\r\n              )}\r\n              isValidConnection={validateInput}\r\n              title=\"Input Image (Base64)\"\r\n            />\r\n            <span className=\"absolute top-1/2 left-4 -translate-y-1/2 text-[10px] whitespace-nowrap text-gray-500\">\r\n              Input Image\r\n            </span>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded bg-white/5 p-3\">\r\n          <p className=\"mb-2 text-xs font-semibold text-gray-400\">\r\n            Crop Percentages\r\n          </p>\r\n          <div className=\"grid grid-cols-2 gap-2\">\r\n            <div className=\"flex flex-col gap-1\">\r\n              <label className=\"text-[10px] text-gray-500\">\r\n                X Position (%)\r\n              </label>\r\n              <input\r\n                type=\"number\"\r\n                className=\"rounded border border-white/10 bg-black/50 px-2 py-1 text-xs text-white outline-none focus:border-[#E0FC00]\"\r\n                value={cropParams.x}\r\n                onChange={(e) => handleParamChange(\"x\", e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"flex flex-col gap-1\">\r\n              <label className=\"text-[10px] text-gray-500\">\r\n                Y Position (%)\r\n              </label>\r\n              <input\r\n                type=\"number\"\r\n                className=\"rounded border border-white/10 bg-black/50 px-2 py-1 text-xs text-white outline-none focus:border-[#E0FC00]\"\r\n                value={cropParams.y}\r\n                onChange={(e) => handleParamChange(\"y\", e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"flex flex-col gap-1\">\r\n              <label className=\"text-[10px] text-gray-500\">Width (%)</label>\r\n              <input\r\n                type=\"number\"\r\n                className=\"rounded border border-white/10 bg-black/50 px-2 py-1 text-xs text-white outline-none focus:border-[#E0FC00]\"\r\n                value={cropParams.width}\r\n                onChange={(e) => handleParamChange(\"width\", e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"flex flex-col gap-1\">\r\n              <label className=\"text-[10px] text-gray-500\">Height (%)</label>\r\n              <input\r\n                type=\"number\"\r\n                className=\"rounded border border-white/10 bg-black/50 px-2 py-1 text-xs text-white outline-none focus:border-[#E0FC00]\"\r\n                value={cropParams.height}\r\n                onChange={(e) => handleParamChange(\"height\", e.target.value)}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <button\r\n          onClick={handleCrop}\r\n          disabled={isProcessing}\r\n          className={cn(\r\n            \"w-full rounded py-2 text-xs font-bold tracking-wider uppercase transition-colors\",\r\n            isProcessing\r\n              ? \"cursor-not-allowed bg-gray-700 text-gray-400\"\r\n              : \"bg-[#E0FC00] text-black hover:bg-[#cbe600]\",\r\n          )}\r\n        >\r\n          {isProcessing ? \"Cropping...\" : \"Crop Image\"}\r\n        </button>\r\n\r\n        {/* Result Preview */}\r\n        {data.imageUrl && (\r\n          <div className=\"flex flex-col gap-2\">\r\n            <span className=\"text-[10px] font-bold text-gray-500 uppercase\">\r\n              Result\r\n            </span>\r\n            <div className=\"relative aspect-video w-full overflow-hidden rounded border border-white/10 bg-black/50\">\r\n              {/* eslint-disable-next-line @next/next/no-img-element */}\r\n              <img\r\n                src={data.imageUrl}\r\n                alt=\"Cropped\"\r\n                className=\"h-full w-full object-contain\"\r\n              />\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Output Handle */}\r\n      <div className=\"relative flex h-10 items-center justify-end border-t border-white/5 bg-[#222] px-4\">\r\n        <span className=\"mr-2 text-xs text-gray-500\">image</span>\r\n        <Handle\r\n          type=\"source\"\r\n          position={Position.Right}\r\n          id=\"image\"\r\n          className=\"!h-3 !w-3 !border-2 !border-[#1A1A1A] !bg-[#E0FC00]\"\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\91895\\Desktop\\projects\\weavy-clone\\src\\components\\workflow\\nodes\\ExtractVideoFrameNode.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":53,"column":35,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":53,"endColumn":37,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1584,1586],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-type-assertion","severity":2,"message":"This assertion is unnecessary since it does not change the type of the expression.","line":58,"column":19,"nodeType":"TSAsExpression","messageId":"unnecessaryAssertion","endLine":58,"endColumn":74,"fix":{"range":[1790,1829],"text":""}},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":59,"column":29,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":59,"endColumn":31,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1860,1862],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":139,"column":25,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":139,"endColumn":27,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[4689,4691],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":209,"column":15,"nodeType":"JSXOpeningElement","endLine":213,"endColumn":17,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport {\r\n  Handle,\r\n  Position,\r\n  useReactFlow,\r\n  useHandleConnections,\r\n} from \"@xyflow/react\";\r\nimport React, { useState } from \"react\";\r\nimport type { Node, NodeProps, Connection, Edge } from \"@xyflow/react\";\r\nimport { Smartphone } from \"lucide-react\";\r\nimport { cn } from \"~/lib/utils\";\r\nimport { useFlowStore } from \"~/store/flowStore\";\r\nimport { toast } from \"sonner\";\r\n\r\n// Define the data type for our node\r\ntype ExtractVideoFrameNodeData = {\r\n  label?: string;\r\n  imageUrl?: string; // The output extracted frame (Base64)\r\n};\r\n\r\ntype MyNode = Node<ExtractVideoFrameNodeData>;\r\n\r\nexport function ExtractVideoFrameNode({\r\n  data,\r\n  selected,\r\n  id,\r\n}: NodeProps<MyNode>) {\r\n  const { updateNodeData, nodeData } = useFlowStore();\r\n  const { getEdges, getNodes } = useReactFlow();\r\n\r\n  // Timestamp input (seconds)\r\n  const [timestamp, setTimestamp] = useState<number>(0);\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n\r\n  // Input connection tracking\r\n  const connections = useHandleConnections({ type: \"target\", id: \"video\" });\r\n\r\n  // Helper to get input video URL from connection\r\n  const getInputVideo = () => {\r\n    const edges = getEdges();\r\n    const nodes = getNodes();\r\n\r\n    // Find edge connected to our 'video' handle\r\n    const edge = edges.find(\r\n      (e) => e.target === id && e.targetHandle === \"video\",\r\n    );\r\n    if (!edge) return null;\r\n\r\n    // Try store first (live data)\r\n    if (nodeData[edge.source]) {\r\n      const sourceData = nodeData[edge.source] as Record<string, unknown>;\r\n      return (sourceData.mediaUrl || sourceData.video) as string | undefined; // Support conventions\r\n    }\r\n\r\n    // Fallback to node data\r\n    const sourceNode = nodes.find((n) => n.id === edge.source);\r\n    const sData = sourceNode?.data as Record<string, unknown> | undefined;\r\n    return (sData?.mediaUrl || sData?.video) as string | undefined;\r\n  };\r\n\r\n  const validateInput = (connection: Connection | Edge) => {\r\n    // connection.sourceHandle is the ID of the handle on the source node\r\n    const sourceHandleId = connection.sourceHandle;\r\n\r\n    // Only allow connection if the source handle is explicitly a video output\r\n    if (sourceHandleId === \"video\") return true;\r\n    return false;\r\n  };\r\n\r\n  const handleExtract = async () => {\r\n    const inputVideo = getInputVideo();\r\n\r\n    if (!inputVideo || typeof inputVideo !== \"string\") {\r\n      toast.error(\"No input video detected\", {\r\n        description:\r\n          \"Please connect a video output (like Upload Video) to this node.\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (!inputVideo.startsWith(\"data:video/\") && !inputVideo.startsWith(\"data:application/octet-stream\")) {\r\n       // Note: Some browsers might read video as octet-stream. \r\n       // Sticking to strict check if possible, but alerting user.\r\n       if(!inputVideo.startsWith(\"data:\")){\r\n            toast.error(\"Invalid Input Format\", {\r\n                description: \"The connected node must provide a Base64 Data URL.\"\r\n            });\r\n            return;\r\n       }\r\n    }\r\n\r\n    // Timestamp validation\r\n    if (timestamp < 0) {\r\n        toast.error(\"Invalid Timestamp\", {\r\n            description: \"Timestamp must be a non-negative number.\"\r\n        });\r\n        return;\r\n    }\r\n\r\n    setIsProcessing(true);\r\n    try {\r\n      const { extractVideoFrame } = await import(\"~/app/actions\");\r\n\r\n      toast.promise(extractVideoFrame(inputVideo, timestamp), {\r\n        loading: \"Extracting frame...\",\r\n        success: (result) => {\r\n          // Update local data and global store with result\r\n          updateNodeData(id, { imageUrl: result.url });\r\n          return \"Frame Extracted Successfully\";\r\n        },\r\n        error: (err) => {\r\n          console.error(\"Extraction error\", err);\r\n          return \"Extraction Failed\";\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Action import failed\", error);\r\n      toast.error(\"Failed to start extraction process\");\r\n    } finally {\r\n      setIsProcessing(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"group relative flex w-80 flex-col rounded-xl border-2 bg-[#1A1A1A] text-white shadow-2xl transition-all\",\r\n        selected\r\n          ? \"border-[#E0FC00] shadow-[#E0FC00]/20\"\r\n          : \"border-white/10 hover:border-white/20\",\r\n      )}\r\n    >\r\n      {/* Header */}\r\n      <div className=\"flex h-10 items-center justify-between border-b border-white/5 bg-[#222] px-4 py-2\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <Smartphone className=\"h-4 w-4 text-[#E0FC00]\" />\r\n          <span className=\"text-xs font-semibold tracking-wider text-gray-400 uppercase\">\r\n            {data.label || \"Extract Frame\"}\r\n          </span>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex flex-col gap-4 p-4\">\r\n        {/* Input Handle Visualization */}\r\n        <div className=\"relative\">\r\n          <div className=\"absolute top-1/2 -left-7 -translate-y-1/2\">\r\n            <Handle\r\n              type=\"target\"\r\n              position={Position.Left}\r\n              id=\"video\"\r\n              className={cn(\r\n                \"!relative !left-0 !h-3 !w-3 !border-2 !border-[#1A1A1A]\",\r\n                connections.length > 0 ? \"!bg-green-500\" : \"!bg-indigo-500\",\r\n              )}\r\n              isValidConnection={validateInput}\r\n              title=\"Input Video (Base64)\"\r\n            />\r\n            <span className=\"absolute top-1/2 left-4 -translate-y-1/2 text-[10px] whitespace-nowrap text-gray-500\">\r\n              Input Video\r\n            </span>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded bg-white/5 p-3\">\r\n          <p className=\"mb-2 text-xs font-semibold text-gray-400\">\r\n            Extraction Settings\r\n          </p>\r\n          <div className=\"flex flex-col gap-1\">\r\n            <label className=\"text-[10px] text-gray-500\">\r\n              Timestamp (Seconds)\r\n            </label>\r\n            <input\r\n              type=\"number\"\r\n              min=\"0\"\r\n              step=\"0.1\"\r\n              className=\"rounded border border-white/10 bg-black/50 px-2 py-1 text-xs text-white outline-none focus:border-[#E0FC00]\"\r\n              value={timestamp}\r\n              onChange={(e) => {\r\n                  const val = parseFloat(e.target.value);\r\n                  if(!isNaN(val)) setTimestamp(val);\r\n                  else setTimestamp(0); // or handle empty string better\r\n              }}\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <button\r\n          onClick={handleExtract}\r\n          disabled={isProcessing}\r\n          className={cn(\r\n            \"w-full rounded py-2 text-xs font-bold tracking-wider uppercase transition-colors\",\r\n            isProcessing\r\n              ? \"cursor-not-allowed bg-gray-700 text-gray-400\"\r\n              : \"bg-[#E0FC00] text-black hover:bg-[#cbe600]\",\r\n          )}\r\n        >\r\n          {isProcessing ? \"Extracting...\" : \"Extract Frame\"}\r\n        </button>\r\n\r\n        {/* Result Preview */}\r\n        {data.imageUrl && (\r\n          <div className=\"flex flex-col gap-2\">\r\n            <span className=\"text-[10px] font-bold text-gray-500 uppercase\">\r\n              Result\r\n            </span>\r\n            <div className=\"relative aspect-video w-full overflow-hidden rounded border border-white/10 bg-black/50\">\r\n              {/* eslint-disable-next-line @next/next/no-img-element */}\r\n              <img\r\n                src={data.imageUrl}\r\n                alt=\"Extracted\"\r\n                className=\"h-full w-full object-contain\"\r\n              />\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Output Handle */}\r\n      <div className=\"relative flex h-10 items-center justify-end border-t border-white/5 bg-[#222] px-4\">\r\n        <span className=\"mr-2 text-xs text-gray-500\">image</span>\r\n        <Handle\r\n          type=\"source\"\r\n          position={Position.Right}\r\n          id=\"image\"\r\n          className=\"!h-3 !w-3 !border-2 !border-[#1A1A1A] !bg-[#E0FC00]\"\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\91895\\Desktop\\projects\\weavy-clone\\src\\components\\workflow\\nodes\\RunLLMNode.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":47,"column":42,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":47,"endColumn":44,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1315,1317],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport {\r\n  Handle,\r\n  Position,\r\n  useReactFlow,\r\n  useHandleConnections,\r\n} from \"@xyflow/react\";\r\nimport type { Node, NodeProps, Connection, Edge } from \"@xyflow/react\";\r\nimport { Bot, Image as ImageIcon } from \"lucide-react\";\r\nimport { cn } from \"~/lib/utils\";\r\nimport { useFlowStore } from \"~/store/flowStore\";\r\nimport { toast } from \"sonner\";\r\n\r\ntype RunLLMNodeData = {\r\n  label?: string;\r\n  result?: string;\r\n  systemUsed?: string;\r\n  promptUsed?: string;\r\n  imageUsed?: string; // Storing the image URL used\r\n};\r\n\r\ntype MyNode = Node<RunLLMNodeData>;\r\n\r\nexport function RunLLMNode({ data, selected, id }: NodeProps<MyNode>) {\r\n  const { getEdges, getNodes } = useReactFlow();\r\n\r\n  // Track connections to enable/disable handles or show status\r\n  const systemConnections = useHandleConnections({\r\n    type: \"target\",\r\n    id: \"system\",\r\n  });\r\n  const promptConnections = useHandleConnections({\r\n    type: \"target\",\r\n    id: \"prompt\",\r\n  });\r\n  const imageConnections = useHandleConnections({\r\n    type: \"target\",\r\n    id: \"image1\",\r\n  });\r\n\r\n  const { setExecutionState, executionState, updateNodeData, nodeData } =\r\n    useFlowStore();\r\n  const isRunning = executionState[id] === \"running\";\r\n\r\n  // Merge initial data (props) with live store data\r\n  const currentStoreData = (nodeData[id] || {}) as Partial<RunLLMNodeData>;\r\n  const currentData = { ...data, ...currentStoreData };\r\n  const { result, systemUsed, promptUsed, imageUsed } = currentData;\r\n\r\n  const validateInput = (\r\n    connection: Connection | Edge,\r\n    expectedSourceType: \"text\" | \"image\",\r\n  ) => {\r\n    // connection.sourceHandle is the ID of the handle on the source node\r\n    const sourceHandleId = connection.sourceHandle;\r\n\r\n    if (expectedSourceType === \"image\") {\r\n      // Only allow connection if the source handle is explicitly an image output\r\n      // We assume nodes outputting images use id=\"image\"\r\n      if (sourceHandleId === \"image\") return true;\r\n      return false;\r\n    }\r\n\r\n    if (expectedSourceType === \"text\") {\r\n      // Allow text inputs from text-like handles\r\n      // We assume nodes outputting text use id=\"text\" (TextNode) or \"result\" (RunLLMNode) or \"prompt\" (RunLLMNode pass-through)\r\n      // Explicitly ban \"image\" handle\r\n      if (sourceHandleId === \"image\") return false;\r\n      return true;\r\n    }\r\n\r\n    return true;\r\n  };\r\n\r\n  const handleRun = async () => {\r\n    const edges = getEdges();\r\n    const nodes = getNodes();\r\n\r\n    // Gather inputs from connected nodes\r\n    const getSourceData = (handleId: string) => {\r\n      const edge = edges.find(\r\n        (e) => e.target === id && e.targetHandle === handleId,\r\n      );\r\n      if (!edge) return null;\r\n\r\n      // Try to get data from global store first (live updates)\r\n      if (nodeData[edge.source]) {\r\n        return nodeData[edge.source];\r\n      }\r\n\r\n      // Fallback to ReactFlow node data\r\n      const sourceNode = nodes.find((n) => n.id === edge.source);\r\n      return sourceNode?.data;\r\n    };\r\n\r\n    const systemData = getSourceData(\"system\");\r\n    const promptData = getSourceData(\"prompt\");\r\n    const imageData = getSourceData(\"image1\");\r\n\r\n    // Helper safely extract text string\r\n    const safeGetText = (obj: unknown): string => {\r\n      if (typeof obj === \"object\" && obj !== null && \"text\" in obj) {\r\n        const val = (obj as Record<string, unknown>).text;\r\n        return typeof val === \"string\" ? val : \"\";\r\n      }\r\n      return \"\";\r\n    };\r\n\r\n    const safeGetImage = (obj: unknown): string | undefined => {\r\n      if (typeof obj === \"object\" && obj !== null) {\r\n        // Check for imageUrl (new convention) or image (legacy)\r\n        if (\"imageUrl\" in obj) {\r\n          const val = (obj as Record<string, unknown>).imageUrl;\r\n          return typeof val === \"string\" ? val : undefined;\r\n        }\r\n        if (\"image\" in obj) {\r\n          const val = (obj as Record<string, unknown>).image;\r\n          return typeof val === \"string\" ? val : undefined;\r\n        }\r\n      }\r\n      return undefined;\r\n    };\r\n\r\n    const systemText = safeGetText(systemData);\r\n    const promptText = safeGetText(promptData);\r\n    const imageUrl = safeGetImage(imageData);\r\n\r\n    setExecutionState(id, \"running\");\r\n\r\n    // Update the node data with what we are about to allow user inspection\r\n    updateNodeData(id, {\r\n      systemUsed: systemText,\r\n      promptUsed: promptText,\r\n      imageUsed: imageUrl,\r\n      result: undefined, // clear previous result\r\n    });\r\n\r\n    // Validation\r\n    if (imageUrl) {\r\n      // Simple check for URL extension\r\n      // User requirements: \"validation will be easy as input will be url ending with .jpg...\"\r\n      const lowerUrl = imageUrl.toLowerCase();\r\n      const isDataUrl = lowerUrl.startsWith(\"data:image/\");\r\n\r\n      if (!isDataUrl) {\r\n        toast.error(\"Invalid Image Input\", {\r\n          description: \"Input must be a Base64 Data URL (data:image/...).\",\r\n        });\r\n        setExecutionState(id, \"failed\");\r\n        return;\r\n      }\r\n    }\r\n\r\n    try {\r\n      const { triggerLLMRun } = await import(\"~/app/actions\");\r\n\r\n      // Trigger and Poll for result\r\n      const runResult = await triggerLLMRun({\r\n        system: systemText,\r\n        prompt: promptText,\r\n        image: imageUrl,\r\n      });\r\n\r\n      // Check if task failed or has error\r\n      if (runResult.error) {\r\n        const err = runResult.error as { message?: string };\r\n        const errorMessage = err.message ?? \"Task failed\";\r\n        throw new Error(errorMessage);\r\n      }\r\n\r\n      const output = runResult.output as { result?: string } | undefined;\r\n\r\n      // Check for valid output\r\n      if (!output?.result) {\r\n        console.warn(\"AI returned empty result\", runResult);\r\n        toast.error(\"AI response generation failed: Recieved empty response\", {\r\n          description: \"Please try again or check your prompt.\",\r\n        });\r\n        setExecutionState(id, \"failed\");\r\n        return;\r\n      }\r\n\r\n      const aiText = output.result;\r\n\r\n      updateNodeData(id, {\r\n        result: aiText,\r\n        // Keeping inputs in data so they persist in UI\r\n        systemUsed: systemText,\r\n        promptUsed: promptText,\r\n        imageUsed: imageUrl,\r\n      });\r\n      setExecutionState(id, \"completed\");\r\n      toast.success(\"AI Generation Complete\");\r\n    } catch (error) {\r\n      console.error(\"RunLLM execution error:\", error);\r\n      let message = \"Unknown error occurred\";\r\n      if (error instanceof Error) message = error.message;\r\n\r\n      toast.error(\"AI Generation Failed\", {\r\n        description: message,\r\n      });\r\n      setExecutionState(id, \"failed\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"group relative flex w-80 flex-col rounded-xl border-2 bg-[#1A1A1A] text-white shadow-2xl transition-all\",\r\n        selected\r\n          ? \"border-[#E0FC00] shadow-[#E0FC00]/20\"\r\n          : \"border-white/10 hover:border-white/20\",\r\n      )}\r\n    >\r\n      {/* Header */}\r\n      <div className=\"flex h-10 items-center justify-between rounded-t-xl border-b border-white/5 bg-[#222] px-4 py-2\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <Bot className=\"h-4 w-4 text-[#E0FC00]\" />\r\n          <span className=\"text-xs font-semibold tracking-wider text-gray-400 uppercase\">\r\n            {data.label ?? \"Run LLM\"}\r\n          </span>\r\n        </div>\r\n        <button\r\n          onClick={handleRun}\r\n          disabled={isRunning}\r\n          className={cn(\r\n            \"rounded px-2 py-1 text-[10px] font-bold uppercase transition-colors\",\r\n            isRunning\r\n              ? \"cursor-not-allowed bg-gray-700 text-gray-400\"\r\n              : \"bg-[#E0FC00] text-black hover:bg-[#cbe600]\",\r\n          )}\r\n        >\r\n          {isRunning ? \"Running...\" : \"Run\"}\r\n        </button>\r\n      </div>\r\n\r\n      {/* Main Body */}\r\n      <div className=\"relative flex min-h-[120px] flex-col gap-3 p-4\">\r\n        {/* Input Handles */}\r\n        <div className=\"absolute top-4 -left-3 flex flex-col gap-6\">\r\n          <Handle\r\n            type=\"target\"\r\n            position={Position.Left}\r\n            id=\"prompt\"\r\n            className=\"!relative !left-0 !h-3 !w-3 !border-2 !border-[#1A1A1A] !bg-gray-500\"\r\n            isValidConnection={(c) => validateInput(c, \"text\")}\r\n            isConnectable={promptConnections.length === 0}\r\n            title=\"User Prompt\"\r\n          />\r\n          <Handle\r\n            type=\"target\"\r\n            position={Position.Left}\r\n            id=\"system\"\r\n            className=\"!relative !left-0 !h-3 !w-3 !border-2 !border-[#1A1A1A] !bg-gray-500\"\r\n            isValidConnection={(c) => validateInput(c, \"text\")}\r\n            isConnectable={systemConnections.length === 0}\r\n            title=\"System Prompt\"\r\n          />\r\n          <Handle\r\n            type=\"target\"\r\n            position={Position.Left}\r\n            id=\"image1\" // Kept as image1 based on previous code, mapped to image payload\r\n            className=\"!relative !left-0 !h-3 !w-3 !border-2 !border-[#1A1A1A] !bg-indigo-500\"\r\n            isValidConnection={(c) => validateInput(c, \"image\")}\r\n            isConnectable={imageConnections.length === 0}\r\n            title=\"Image\"\r\n          />\r\n        </div>\r\n\r\n        {/* Info Section (System & User Used) */}\r\n        {(!!systemUsed || !!promptUsed || !!imageUsed) && (\r\n          <div className=\"mb-2 flex flex-col gap-2 rounded bg-white/5 p-2 text-xs\">\r\n            {systemUsed && (\r\n              <div className=\"flex flex-col gap-0.5\">\r\n                <span className=\"text-[10px] font-semibold text-gray-500 uppercase\">\r\n                  System\r\n                </span>\r\n                <span className=\"line-clamp-2 text-gray-300\" title={systemUsed}>\r\n                  {systemUsed}\r\n                </span>\r\n              </div>\r\n            )}\r\n            {promptUsed && (\r\n              <div className=\"flex flex-col gap-0.5\">\r\n                <span className=\"text-[10px] font-semibold text-gray-500 uppercase\">\r\n                  User\r\n                </span>\r\n                <span className=\"line-clamp-2 text-gray-300\" title={promptUsed}>\r\n                  {promptUsed}\r\n                </span>\r\n              </div>\r\n            )}\r\n            {imageUsed && (\r\n              <div className=\"flex flex-col gap-0.5\">\r\n                <div className=\"flex items-center gap-1\">\r\n                  <ImageIcon className=\"h-3 w-3 text-indigo-400\" />\r\n                  <span className=\"text-[10px] font-semibold text-gray-500 uppercase\">\r\n                    Image\r\n                  </span>\r\n                </div>\r\n                <a\r\n                  href={imageUsed}\r\n                  target=\"_blank\"\r\n                  rel=\"noopener noreferrer\"\r\n                  className=\"line-clamp-1 break-all text-indigo-300 underline hover:text-indigo-200\"\r\n                  title={imageUsed}\r\n                >\r\n                  {imageUsed}\r\n                </a>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Result Area */}\r\n        <div\r\n          className={cn(\r\n            \"h-full w-full rounded bg-black/50 p-3 font-mono text-sm leading-relaxed\",\r\n            result ? \"text-gray-300\" : \"text-gray-600 italic\",\r\n          )}\r\n        >\r\n          {result ?? \"AI response\"}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Footer / Output Handle */}\r\n      <div className=\"relative flex items-center justify-end rounded-b-xl border-t border-white/5 bg-[#222] p-2\">\r\n        <span className=\"mr-2 text-[10px] text-gray-500\">result</span>\r\n        <Handle\r\n          type=\"source\"\r\n          position={Position.Right}\r\n          id=\"result\"\r\n          className=\"!h-3 !w-3 !border-2 !border-[#1A1A1A] !bg-[#E0FC00]\"\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\91895\\Desktop\\projects\\weavy-clone\\src\\components\\workflow\\nodes\\TextNode.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Move' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Move"},"fix":{"range":[132,137],"text":""},"desc":"Remove unused variable \"Move\"."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":34,"column":46,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":34,"endColumn":48,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[890,892],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":58,"column":23,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":58,"endColumn":25,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1857,1859],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'connection' is defined but never used. Allowed unused args must match /^_/u.","line":84,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":84,"endColumn":41}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport type { Node, NodeProps } from \"@xyflow/react\";\r\nimport { Handle, Position } from \"@xyflow/react\";\r\nimport { Move, GripHorizontal } from \"lucide-react\";\r\nimport { useState } from \"react\";\r\nimport { cn } from \"~/lib/utils\";\r\nimport { useFlowStore } from \"~/store/flowStore\";\r\n\r\n/**\r\n * Data flow structure for the TextNode.\r\n * @property {string} [label] - The display label of the node.\r\n * @property {string} [text] - The text content entered by the user.\r\n *\r\n * Example JSON:\r\n * {\r\n *   \"id\": \"1\",\r\n *   \"type\": \"text\",\r\n *   \"data\": {\r\n *     \"label\": \"Text\",\r\n *     \"text\": \"Hello world\"\r\n *   }\r\n * }\r\n */\r\ntype TextNodeData = {\r\n  label?: string;\r\n  text?: string;\r\n};\r\n\r\ntype MyNode = Node<TextNodeData>;\r\n\r\nexport function TextNode({ data, selected, id }: NodeProps<MyNode>) {\r\n  // Local state for text input\r\n  const [text, setText] = useState(data.text || \"\");\r\n\r\n  // Access global store to update node data\r\n  const updateNodeData = useFlowStore((state) => state.updateNodeData);\r\n\r\n  // Update local state and global store when text changes\r\n  const handleTextChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\r\n    const newVal = e.target.value;\r\n    setText(newVal);\r\n    updateNodeData(id, { text: newVal });\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"group relative flex w-80 flex-col overflow-hidden rounded-xl border-2 bg-[#1A1A1A] text-white shadow-2xl transition-all\",\r\n        selected\r\n          ? \"border-[#E0FC00] shadow-[#E0FC00]/20\"\r\n          : \"border-white/10 hover:border-white/20\",\r\n      )}\r\n    >\r\n      {/* Header Strip with Handle for Dragging */}\r\n      <div className=\"flex h-10 items-center justify-between border-b border-white/5 bg-[#222] px-4 py-2\">\r\n        <span className=\"text-xs font-semibold tracking-wider text-gray-400 uppercase\">\r\n          {data.label || \"Text\"}\r\n        </span>\r\n        {/* Visual grip handle */}\r\n        <GripHorizontal className=\"h-4 w-4 text-gray-600\" />\r\n      </div>\r\n\r\n      {/* Content Area */}\r\n      <div className=\"p-4\">\r\n        <label className=\"mb-2 block text-xs text-gray-500\">Text Content</label>\r\n        <textarea\r\n          className=\"nodrag w-full resize-none rounded-lg border border-white/10 bg-black/40 p-3 text-sm text-gray-200 placeholder-gray-600 transition-all focus:border-[#E0FC00]/50 focus:ring-1 focus:ring-[#E0FC00]/50 focus:outline-none\"\r\n          rows={4}\r\n          value={text}\r\n          onChange={handleTextChange}\r\n          placeholder=\"Enter text...\"\r\n        />\r\n      </div>\r\n\r\n      {/* Output Handle */}\r\n      <div className=\"relative flex h-10 items-center justify-end border-t border-white/5 bg-[#222] px-4\">\r\n        <span className=\"mr-2 text-xs text-gray-500\">text</span>\r\n        <Handle\r\n          type=\"source\"\r\n          position={Position.Right}\r\n          id=\"text\"\r\n          className=\"!h-3 !w-3 !border-2 !border-[#1A1A1A] !bg-[#E0FC00]\"\r\n          isValidConnection={(connection) => {\r\n            // Validation: Output is generic text\r\n            return true;\r\n          }}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\91895\\Desktop\\projects\\weavy-clone\\src\\components\\workflow\\nodes\\UploadImageNode.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":30,"column":57,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":30,"endColumn":59,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1099,1101],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-misused-promises","severity":2,"message":"Promise-returning function provided to property where a void return was expected.","line":67,"column":5,"nodeType":"Identifier","messageId":"voidReturnProperty","endLine":67,"endColumn":11},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":84,"column":56,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":84,"endColumn":58,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2843,2845],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":108,"column":23,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":108,"endColumn":25,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3626,3628],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":117,"column":13,"nodeType":"JSXOpeningElement","endLine":121,"endColumn":15,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Handle, Position } from \"@xyflow/react\";\r\nimport React, { useCallback, useState } from \"react\";\r\nimport { useDropzone, type FileRejection } from \"react-dropzone\";\r\nimport type { Node, NodeProps } from \"@xyflow/react\";\r\nimport { X, Upload } from \"lucide-react\";\r\nimport { cn } from \"~/lib/utils\";\r\nimport { useFlowStore } from \"~/store/flowStore\";\r\nimport { toast } from \"sonner\";\r\n\r\n// Define the data type for our node\r\ntype UploadImageNodeData = {\r\n  label?: string;\r\n  imageUrl?: string;\r\n};\r\n\r\ntype MyNode = Node<UploadImageNodeData>;\r\n\r\nexport function UploadImageNode({ data, selected, id }: NodeProps<MyNode>) {\r\n  const { updateNodeData } = useFlowStore();\r\n  const [imageUrl, setImageUrl] = useState<string | undefined>(data.imageUrl);\r\n\r\n  // Handle file drop - only accepts one image\r\n  const onDrop = useCallback(\r\n    async (acceptedFiles: File[], fileRejections: FileRejection[]) => {\r\n      // Handle rejections\r\n      if (fileRejections.length > 0) {\r\n        fileRejections.forEach((rejection) => {\r\n          const errorMsg = rejection.errors[0]?.message || \"Unknown error\";\r\n          toast.error(`Upload Failed: ${errorMsg}`);\r\n        });\r\n        return;\r\n      }\r\n\r\n      const file = acceptedFiles[0];\r\n      if (file) {\r\n        // Create a local object URL for preview immediately\r\n        const objectUrl = URL.createObjectURL(file);\r\n        setImageUrl(objectUrl);\r\n\r\n        try {\r\n          // Convert to Base64 Data URL\r\n          const reader = new FileReader();\r\n          reader.onerror = () => {\r\n            toast.error(\"Failed to read file\");\r\n          };\r\n          reader.onload = () => {\r\n            const base64String = reader.result as string;\r\n            // Update global flow store with the base64 string\r\n            updateNodeData(id, { imageUrl: base64String });\r\n            toast.success(\"Image processed (Base64)\");\r\n          };\r\n          reader.readAsDataURL(file);\r\n        } catch (error) {\r\n          console.error(\"File reading error:\", error);\r\n          toast.error(\"Failed to process file\");\r\n        }\r\n\r\n        console.log(\"File dropped:\", file);\r\n      }\r\n    },\r\n    [id, updateNodeData],\r\n  );\r\n\r\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({\r\n    onDrop,\r\n    accept: {\r\n      \"image/jpeg\": [],\r\n      \"image/png\": [],\r\n      \"image/webp\": [],\r\n      \"image/gif\": [],\r\n    },\r\n    maxSize: 10 * 1024 * 1024, // 10MB\r\n    multiple: false,\r\n    onDropRejected: (fileRejections) => {\r\n      fileRejections.forEach((rejection) => {\r\n        const errorCode = rejection.errors[0]?.code;\r\n        if (errorCode === \"file-too-large\") {\r\n          toast.error(\"File is too large\", {\r\n            description: \"Image must be less than 10MB\",\r\n          });\r\n        } else {\r\n          const message = rejection.errors[0]?.message || \"Unknown error\";\r\n          toast.error(`Upload Failed: ${message}`);\r\n        }\r\n      });\r\n    },\r\n  });\r\n\r\n  const clearImage = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    setImageUrl(undefined);\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"group relative flex w-80 flex-col overflow-hidden rounded-xl border-2 bg-[#1A1A1A] text-white shadow-2xl transition-all\",\r\n        selected\r\n          ? \"border-[#E0FC00] shadow-[#E0FC00]/20\"\r\n          : \"border-white/10 hover:border-white/20\",\r\n      )}\r\n    >\r\n      {/* Header */}\r\n      <div className=\"flex h-10 items-center justify-between border-b border-white/5 bg-[#222] px-4 py-2\">\r\n        <span className=\"text-xs font-semibold tracking-wider text-gray-400 uppercase\">\r\n          {data.label || \"Upload Image\"}\r\n        </span>\r\n      </div>\r\n\r\n      {/* Content Area */}\r\n      <div className=\"flex min-h-[150px] flex-col items-center justify-center p-4\">\r\n        {imageUrl ? (\r\n          <div className=\"group/image relative aspect-video w-full overflow-hidden rounded-lg border border-white/10\">\r\n            {/* eslint-disable-next-line @next/next/no-img-element */}\r\n            <img\r\n              src={imageUrl}\r\n              alt=\"Uploaded\"\r\n              className=\"h-full w-full object-cover\"\r\n            />\r\n            <button\r\n              onClick={clearImage}\r\n              className=\"absolute top-2 right-2 rounded-full bg-black/50 p-1 opacity-0 transition-colors group-hover/image:opacity-100 hover:bg-red-500/80\"\r\n            >\r\n              <X className=\"h-4 w-4 text-white\" />\r\n            </button>\r\n          </div>\r\n        ) : (\r\n          <div\r\n            {...getRootProps()}\r\n            className={cn(\r\n              \"flex h-32 w-full cursor-pointer flex-col items-center justify-center rounded-lg border-2 border-dashed border-white/10 bg-white/5 transition-colors\",\r\n              isDragActive\r\n                ? \"border-[#E0FC00] bg-[#E0FC00]/5\"\r\n                : \"hover:border-white/20 hover:bg-white/10\",\r\n            )}\r\n          >\r\n            <input {...getInputProps()} />\r\n            <Upload\r\n              className={cn(\r\n                \"mb-2 h-8 w-8 text-gray-400\",\r\n                isDragActive && \"text-[#E0FC00]\",\r\n              )}\r\n            />\r\n            <p className=\"px-4 text-center text-xs text-gray-400\">\r\n              {isDragActive\r\n                ? \"Drop image here...\"\r\n                : \"Drag & drop or click to upload\"}\r\n            </p>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Output Handle */}\r\n      <div className=\"relative flex h-10 items-center justify-end border-t border-white/5 bg-[#222] px-4\">\r\n        <span className=\"mr-2 text-xs text-gray-500\">image</span>\r\n        <Handle\r\n          type=\"source\"\r\n          position={Position.Right}\r\n          id=\"image\"\r\n          className=\"!h-3 !w-3 !border-2 !border-[#1A1A1A] !bg-[#E0FC00]\"\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\91895\\Desktop\\projects\\weavy-clone\\src\\components\\workflow\\nodes\\UploadVideoNode.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":41,"column":61,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":41,"endColumn":63,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1513,1515],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-misused-promises","severity":2,"message":"Promise-returning function provided to property where a void return was expected.","line":88,"column":5,"nodeType":"Identifier","messageId":"voidReturnProperty","endLine":88,"endColumn":11},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":103,"column":56,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":103,"endColumn":58,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3483,3485],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":169,"column":23,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":169,"endColumn":25,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[5482,5484],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Handle, Position, type Node, type NodeProps } from \"@xyflow/react\";\r\nimport React, { useCallback, useState, useEffect } from \"react\";\r\nimport { useDropzone, type FileRejection } from \"react-dropzone\";\r\nimport { X, FileVideo, FileAudio, ImageIcon } from \"lucide-react\";\r\nimport Image from \"next/image\";\r\nimport { cn } from \"~/lib/utils\";\r\nimport { useFlowStore } from \"~/store/flowStore\";\r\nimport { toast } from \"sonner\";\r\n\r\n// Define the data type for our node\r\ntype UploadVideoNodeData = {\r\n  label?: string;\r\n  mediaUrl?: string;\r\n  mediaType?: string;\r\n};\r\n\r\ntype MyNode = Node<UploadVideoNodeData>;\r\n\r\nexport function UploadVideoNode({ data, selected, id }: NodeProps<MyNode>) {\r\n  const { updateNodeData } = useFlowStore();\r\n  // Manage video URL and type state locally\r\n  const [mediaUrl, setMediaUrl] = useState<string | undefined>(data.mediaUrl);\r\n  const [mediaType, setMediaType] = useState<string | undefined>(\r\n    data.mediaType,\r\n  );\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n\r\n  // Sync local state with data prop if it changes externally\r\n  useEffect(() => {\r\n    setMediaUrl(data.mediaUrl);\r\n    setMediaType(data.mediaType);\r\n  }, [data.mediaUrl, data.mediaType]);\r\n\r\n  const onDrop = useCallback(\r\n    async (acceptedFiles: File[], fileRejections: FileRejection[]) => {\r\n      // Handle rejections\r\n      if (fileRejections.length > 0) {\r\n        fileRejections.forEach((rejection) => {\r\n          const errorMessage = rejection.errors[0]?.message || \"Unknown error\";\r\n          toast.error(`Upload Failed: ${errorMessage}`);\r\n        });\r\n        return;\r\n      }\r\n\r\n      const file = acceptedFiles[0];\r\n      if (file) {\r\n        setIsProcessing(true);\r\n        // Create a local object URL for preview immediately\r\n        const objectUrl = URL.createObjectURL(file);\r\n        setMediaUrl(objectUrl);\r\n        setMediaType(file.type);\r\n\r\n        toast.info(\"Processing file...\");\r\n\r\n        try {\r\n          // Convert to Base64 Data URL\r\n          const reader = new FileReader();\r\n          reader.onerror = () => {\r\n            toast.error(\"Failed to read file\");\r\n            setIsProcessing(false);\r\n          };\r\n          reader.onload = () => {\r\n            const base64String = reader.result as string;\r\n            // Update global flow store with the base64 string\r\n            updateNodeData(id, {\r\n              mediaUrl: base64String,\r\n              mediaType: file.type,\r\n            });\r\n            toast.success(\"File processed successfully\");\r\n            setIsProcessing(false);\r\n          };\r\n          reader.readAsDataURL(file);\r\n        } catch (error) {\r\n          console.error(\"File reading error:\", error);\r\n          toast.error(\"Failed to process file\");\r\n          setIsProcessing(false);\r\n        }\r\n\r\n        console.log(\"File dropped:\", file);\r\n      }\r\n    },\r\n    [id, updateNodeData],\r\n  );\r\n\r\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({\r\n    onDrop,\r\n    accept: {\r\n      \"video/mp4\": [],\r\n      \"audio/mpeg\": [],\r\n      \"image/webp\": [],\r\n    },\r\n    maxSize: 100 * 1024 * 1024, // 100MB\r\n    multiple: false,\r\n    disabled: isProcessing,\r\n    onDropRejected: (fileRejections) => {\r\n      fileRejections.forEach((rejection) => {\r\n        const errorCode = rejection.errors[0]?.code;\r\n        if (errorCode === \"file-too-large\") {\r\n          toast.error(\"File is too large\");\r\n        } else {\r\n          const message = rejection.errors[0]?.message || \"Unknown error\";\r\n          toast.error(`Upload Failed: ${message}`);\r\n        }\r\n      });\r\n    },\r\n  });\r\n\r\n  const clearMedia = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    setMediaUrl(undefined);\r\n    setMediaType(undefined);\r\n    updateNodeData(id, { mediaUrl: undefined, mediaType: undefined });\r\n  };\r\n\r\n  const renderMediaPreview = () => {\r\n    if (!mediaUrl) return null;\r\n\r\n    // Check media type (either from state or sniff from data url)\r\n    // ensure type is always a string\r\n    const mimeFromData = mediaUrl.startsWith(\"data:\")\r\n      ? mediaUrl.split(\";\")[0]?.split(\":\")[1]\r\n      : \"\";\r\n    const type = mediaType ?? mimeFromData ?? \"\";\r\n\r\n    if (type.startsWith(\"video/\")) {\r\n      return (\r\n        <video\r\n          src={mediaUrl}\r\n          controls\r\n          className=\"h-full w-full bg-black object-contain\"\r\n        />\r\n      )\r\n    } else if (type.startsWith(\"audio/\")) {\r\n      return (\r\n        <div className=\"flex h-full w-full items-center justify-center bg-[#111]\">\r\n          <audio src={mediaUrl} controls className=\"w-[90%]\" />\r\n        </div>\r\n      );\r\n    } else if (type.startsWith(\"image/\")) {\r\n      return (\r\n        <Image\r\n          src={mediaUrl}\r\n          alt=\"Uploaded\"\r\n          fill\r\n          className=\"object-contain\"\r\n          unoptimized\r\n        />\r\n      );\r\n    }\r\n\r\n    // Fallback\r\n    return <div className=\"text-white\">Unsupported media type</div>;\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"group relative flex w-80 flex-col overflow-hidden rounded-xl border-2 bg-[#1A1A1A] text-white shadow-2xl transition-all\",\r\n        selected\r\n          ? \"border-[#E0FC00] shadow-[#E0FC00]/20\"\r\n          : \"border-white/10 hover:border-white/20\",\r\n      )}\r\n    >\r\n      {/* Header */}\r\n      <div className=\"flex h-10 items-center justify-between border-b border-white/5 bg-[#222] px-4 py-2\">\r\n        <span className=\"text-xs font-semibold tracking-wider text-gray-400 uppercase\">\r\n          {data.label || \"Upload Video\"}\r\n        </span>\r\n        {isProcessing && (\r\n          <span className=\"animate-pulse text-xs text-[#E0FC00]\">\r\n            Processing...\r\n          </span>\r\n        )}\r\n      </div>\r\n\r\n      {/* Content Area */}\r\n      <div className=\"flex min-h-[150px] flex-col items-center justify-center bg-black/20 p-4\">\r\n        {mediaUrl ? (\r\n          <div className=\"group/image relative aspect-video w-full overflow-hidden rounded-lg border border-white/10 bg-black\">\r\n            {renderMediaPreview()}\r\n            <button\r\n              onClick={clearMedia}\r\n              className=\"absolute top-2 right-2 z-10 rounded-full bg-black/50 p-1 opacity-0 transition-colors group-hover/image:opacity-100 hover:bg-red-500/80\"\r\n            >\r\n              <X className=\"h-4 w-4 text-white\" />\r\n            </button>\r\n          </div>\r\n        ) : (\r\n          <div\r\n            {...getRootProps()}\r\n            className={cn(\r\n              \"flex h-32 w-full cursor-pointer flex-col items-center justify-center rounded-lg border-2 border-dashed border-white/10 bg-white/5 transition-colors\",\r\n              isDragActive\r\n                ? \"border-[#E0FC00] bg-[#E0FC00]/5\"\r\n                : \"hover:border-white/20 hover:bg-white/10\",\r\n              isProcessing && \"cursor-not-allowed opacity-50\",\r\n            )}\r\n          >\r\n            <input {...getInputProps()} />\r\n            <div className=\"mb-2 flex gap-2\">\r\n              <FileVideo\r\n                className={cn(\r\n                  \"h-6 w-6 text-gray-400\",\r\n                  isDragActive && \"text-[#E0FC00]\",\r\n                )}\r\n              />\r\n              <FileAudio\r\n                className={cn(\r\n                  \"h-6 w-6 text-gray-400\",\r\n                  isDragActive && \"text-[#E0FC00]\",\r\n                )}\r\n              />\r\n              <ImageIcon\r\n                className={cn(\r\n                  \"h-6 w-6 text-gray-400\",\r\n                  isDragActive && \"text-[#E0FC00]\",\r\n                )}\r\n              />\r\n            </div>\r\n\r\n            <p className=\"px-4 text-center text-xs text-gray-400\">\r\n              {isDragActive\r\n                ? \"Drop file here...\"\r\n                : \"Drag & drop mp4, mp3 or webp\"}\r\n            </p>\r\n            <p className=\"mt-1 text-[10px] text-gray-600\">Max 100MB</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Output Handle */}\r\n      <div className=\"relative flex h-10 items-center justify-end border-t border-white/5 bg-[#222] px-4\">\r\n        <span className=\"mr-2 text-xs text-gray-500\">video</span>\r\n        <Handle\r\n          type=\"source\"\r\n          position={Position.Right}\r\n          id=\"video\"\r\n          className=\"!h-3 !w-3 !border-2 !border-[#1A1A1A] !bg-[#E0FC00]\"\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]}]